---
title: "Problems with delta(log(cumulative))"
output: html_notebook
---

```{r}
# This class represents and Non-pharmacological intervention.
# The NPI is in place from day |start| to day |end| inclusive.
setClass("npi",
         slots = list(
           start = "numeric",
           end = "numeric",
           factor = "numeric"
         ))
# Convenient constructor for NPIs.
NPI <-
  function(start, end, factor)
    new("npi",
        start = start,
        end = end,
        factor = factor)

# Returns true if a day is impacted by |npi|
in_npi <- function(npi, i) {
  i >= npi@start && i <= npi@end
}

# Returns the last day impacted by any NPI in |npis|
npis_end <- function(npis) {
  max(sapply(npis, function(x) {
    x@end
  }))
}

r_period <- 7
scale <- function(rate) {
  exp(log(rate) / r_period)
}

createGrowthRates <- function(base_rate, npis) {
  last <- npis_end(npis)
  rates <- numeric()
  for (i in 1:last) {
    rate <- base_rate
    for (npi in npis) {
      if (in_npi(npi, i)) {
        rate <- rate * scale(npi@factor)
      }
    }
    rates <- append(rates, rate)
  }
  rates
}

createPredictor <- function(npi) {
  last <- npis_end(npis)
  pred <- numeric()
  npi_i = 0
  value = 0
  for (i in 1:last) {
    pred <- append(pred, (if (in_npi(npi, i))
      1
      else
        0))
  }
  pred
}

createCases <- function(rates) {
  cases <- c(1)
  for (rate in rates) {
    cases <- append(cases, tail(cases, 1) * rate)
  }
  cases
}

npis <- c(NPI(11, 30, .9), NPI(21, 30, .7))
rates <- createGrowthRates(1.5, npis)

daily = createCases(rates)
cumulative = cumsum(daily)

plot(cases)
plot(cumulative)

d_l_daily <- diff(log(daily))
d_l_cumulative <- diff(log(cumulative))

plot(d_l_daily)
plot(d_l_cumulative)

regress <- function(npis, cases) {
  d_l = diff(log(cases))
  npi1 <- createPredictor(npis[[1]])
  npi2 <- createPredictor(npis[[2]])
  d = data.frame(y = d_l,
                        npi1 = npi1,
                        npi2 = npi2)
  r.model <- lm(y ~ npi1 + npi2, data = d)
  c <- r.model$coefficients
  print("coefficients")
  print(c)
  print("coefficients as rates")
  print(exp(c*r_period))
}

regress(npis, daily)
regress(npis, cumulative)

```
