---
title: "Problems with delta(log(cumulative))"
output: html_notebook
---

```{r}
library(knitr)
# This class represents and Non-pharmacological intervention.
# The NPI is in place from day |start| to day |end| inclusive.
setClass("npi",
         slots = list(
           start = "numeric",
           end = "numeric",
           factor = "numeric"
         ))
# Convenient constructor for NPIs.
NPI <-
  function(start, end, factor)
    new("npi",
        start = start,
        end = end,
        factor = factor)

# Returns true if a day is impacted by |npi|
in_npi <- function(npi, i) {
  i >= npi@start && i <= npi@end
}

# Returns the last day impacted by any NPI in |npis|
npis_end <- function(npis) {
  max(sapply(npis, function(x) {
    x@end
  }))
}

# A vector of 0/1 for each day simulated. A day gets a 1 if the NPI is active on that day, 0 otherwise.
# Used as a predictor in the linear regression.
npi_pred <- function(npis, i) {
  last <- npis_end(npis)
  npi = npis[[i]]
  pred <- numeric()
  value = 0
  for (d in 1:last) {
    pred <- append(pred, (if (in_npi(npi, d))
      1
      else
        0))
  }
  pred
}

# Scales a growth rate so that it becomes |rate| every |period| days.
scale <- function(rate, period) {
  exp(log(rate) / period)
}

# Returns a vector of growth rates by combining |npis| with a base growth rate.
# All growth is scaled over |period| days.
createGrowthRates <- function(r0, npis, period) {
  last <- npis_end(npis)
  rates <- numeric()
  for (i in 1:last) {
    rate <- r0
    for (npi in npis) {
      if (in_npi(npi, i)) {
        rate <- rate * npi@factor
      }
    }
    rates <- append(rates, scale(rate, period))
  }
  rates
}

# Create a timeseries of cases based on the supplied vector of daily growth rates.
createCases <- function(rates) {
  cases <- c(1)
  for (rate in rates) {
    cases <- append(cases, tail(cases, 1) * rate)
  }
  cases
}

# Returns the coefficients for the impact of |npis| by applying linear regression to diff(log(|cases|)).
regress <- function(npis, cases) {
  d_l = diff(log(cases))
  npi1 <- npi_pred(npis, 1)
  npi2 <- npi_pred(npis, 2)
  d = data.frame(y = d_l,
                 npi1 = npi1,
                 npi2 = npi2)
  r.model <- lm(y ~ npi1 + npi2, data = d)
  r.model$coefficients
}

# Dump out some info on the coefficients.
renderRates <- function(c, period, title) {
  print(kable(c, caption=paste("Coefficients using ", title) ))
  rate_c = exp(c * period)
  print(kable(rate_c, caption=paste("Recovered multiplicative rate per ", period, " days using ", title)))
}

# Applying regression and print the results and comparisons.
regressAndRender <- function(npis, cases, period, title) {
  c <- regress(npis, cases)
  renderRates(c, period, title)
  c
}

# Apply the methodology to |npis| with a base growth rate of |r0|.
# Scale all rates to be per |period|
doOne <- function(npis, r0, period) {
  rates <- createGrowthRates(r0, npis, period)
  daily = createCases(rates)
  cumulative = cumsum(daily)

  plot(daily, ylab="daily cases")
  plot(cumulative, ylab="cumulative cases")

  d_l_daily <- diff(log(daily))
  d_l_cumulative <- diff(log(cumulative))

  plot(d_l_daily,ylab="delta(log(daily cases))")
  plot(d_l_cumulative, ylab="delta(log(cumulative cases))")

  c1 = regressAndRender(npis, daily, period, "daily")
  c2 = regressAndRender(npis, cumulative, period, "cumulative")
  list("c1"=c1, "c2"=c2)
}
```

Consider an epidemic with $R_0 = 2.5$ per 7-days.
Apply two NPIs
which cut the 7-day growth rate by 50%,
one running from days 11-30
and the other from days 21-30.

```{r}
npis <- c(NPI(11, 30, 2.5*0.5), NPI(21, 30, 2.5*0.5))
cs = doOne(npis, 2.5, 7)
```

Now consider an identical epidemic
but where the NPIs are non-overlapping
(the second NPI has cuts growth by 75%).
The reason to do this
is to see the impact this has on the outcome of the regression.


```{r}
npis <- c(NPI(11, 20, 0.5), NPI(21, 30, 0.5^2))
cs = doOne(npis, 2.5, 7)
```

Another epidemic where the later NPI is far stronger (80% vs 20%)
but still appear weaker from the regression

```{r}
npis <- c(NPI(11, 30, .8), NPI(21, 30, .2))
cs = doOne(npis, 2.5, 7)
```

Finally in this empidemic we do not get it under control.

```{r}
npis <- c(NPI(11, 30, .8), NPI(21, 30, .8))
cs = doOne(npis, 2.5, 7)
```
